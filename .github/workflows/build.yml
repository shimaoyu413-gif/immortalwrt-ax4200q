name: Build ImmortalWrt for ASUS TUF-AX4200Q

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-24.10
  CONFIG_FILE: .config
  DIY_SCRIPT: diy.sh
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
            gettext git java-propose-classpath libelf-dev libncurses5-dev libncursesw5-dev \
            libssl-dev python3 python3-dev python3-pip python3-setuptools rsync subversion \
            swig unzip wget zlib1g-dev

      - name: Set up ccache
        run: |
          echo 'export PATH="/usr/lib/ccache:$PATH"' >> $GITHUB_ENV
          echo 'CCACHE_DIR=/home/runner/.ccache' >> $GITHUB_ENV
          echo 'CCACHE_COMPRESS=true' >> $GITHUB_ENV
          echo 'CCACHE_MAXSIZE=2G' >> $GITHUB_ENV

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: /home/runner/.ccache
          key: ccache-${{ github.sha }}
          restore-keys: |
            ccache-

      - name: Clone ImmortalWrt
        run: |
          git clone --depth=1 -b "$REPO_BRANCH" "$REPO_URL" openwrt
          ls -la  # ğŸ‘ˆ æŸ¥çœ‹å½“å‰ç›®å½•å†…å®¹ï¼ˆè°ƒè¯•ç”¨ï¼‰
          if [ ! -d "openwrt" ]; then
            echo "âŒ openwrt directory not found after clone!"
            exit 1
          fi

- name: Apply custom config and run DIY script
        run: |
          # å½“å‰ç›®å½•ï¼šä½ çš„ä»“åº“æ ¹ç›®å½•ï¼ˆå« .config å’Œ diy.shï¼‰
          echo "Current dir: $(pwd)"
          ls -la

          if [ -f "$CONFIG_FILE" ]; then
            cp "$CONFIG_FILE" openwrt/.config
            echo "âœ… Custom .config loaded"
          fi

          if [ -f "$DIY_SCRIPT" ]; then
            chmod +x "$DIY_SCRIPT"
            # æ‰§è¡Œ diy.shï¼ˆå®ƒå†…éƒ¨ä¼š cd openwrtï¼‰
            ./"$DIY_SCRIPT"
            echo "âœ… DIY script executed"
          fi
      - name: Prepare build config
        run: |
          cd openwrt
          make defconfig

      - name: Download sources (low concurrency)
        run: |
          cd openwrt
          make download -j2

      - name: Clean tmp to save space
        run: |
          cd openwrt
          rm -rf tmp/*

      - name: Compile firmware
        run: |
          cd openwrt
          export PATH="/usr/lib/ccache:$PATH"
          export CCACHE_DIR=/home/runner/.ccache
          make -j$(nproc) V=s

      - name: Find firmware
        run: |
          find openwrt/bin -name "*asus_tuf-ax4200q*" -type f

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: immortalwrt-tuf-ax4200q-firmware
          path: |
            openwrt/bin/targets/*/*/immortalwrt-*-*-asus_tuf-ax4200q-squashfs-sysupgrade.bin
            openwrt/bin/targets/*/*/immortalwrt-*-*-asus_tuf-ax4200q-squashfs-factory.bin
